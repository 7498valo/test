<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>å¯¿å¸æ‰“ - ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚²ãƒ¼ãƒ </title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Noto Sans JP', Arial, sans-serif;
      background: linear-gradient(to bottom, #fff8dc, #ffe4b5);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 960px; margin: 0 auto; }
    .card {
      background: white;
      border: 5px solid #8B4513;
      border-radius: 10px;
      padding: 30px;
      margin: 20px 0;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      font-size: 4rem;
      color: #CD853F;
      text-shadow: 4px 4px 0 #fff, 8px 8px 0 #8B4513;
      margin-bottom: 10px;
    }
    .subtitle { text-align: center; color: #666; margin-bottom: 30px; }
    .btn {
      display: inline-block;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
      font-size: 1rem;
    }
    .btn:hover { transform: scale(1.05); }
    .btn-green { background: #32CD32; color: white; }
    .btn-blue { background: #4169E1; color: white; }
    .btn-red { background: #DC143C; color: white; }
    .btn-brown { background: #CD853F; color: white; }
    .course-box {
      border: 3px solid;
      border-radius: 8px;
      padding: 20px;
      margin: 15px 0;
      transition: transform 0.3s;
    }
    .course-box:hover { transform: translateY(-5px); }
    .mode-box {
      border: 2px solid #ddd;
      border-radius: 6px;
      padding: 15px;
      margin: 10px 0;
      background: #fafafa;
    }
    .game-area { position: relative; }
    .game-header {
      background: linear-gradient(to bottom, #FFEFD5, #FFE4B5);
      border-bottom: 5px solid #8B4513;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    .belt {
      position: relative;
      height: 300px;
      background: linear-gradient(to bottom, #e8f4f8 0%, #d4e9f0 50%, #c0dfe8 100%);
      overflow: hidden;
      border-top: 3px solid #8B7355;
      border-bottom: 3px solid #8B7355;
    }
    .conveyor {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 80px;
      background: linear-gradient(to bottom, #6B4423 0%, #8B6332 20%, #A67C52 50%, #8B6332 80%, #6B4423 100%);
      border-top: 4px solid #4A3018;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.3), inset 0 -2px 4px rgba(255,255,255,0.1);
    }
    .conveyor::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 100%;
      background-image: 
        repeating-linear-gradient(
          270deg,
          transparent 0px,
          transparent 38px,
          rgba(255,255,255,0.1) 38px,
          rgba(255,255,255,0.1) 40px,
          transparent 40px,
          transparent 45px
        );
      animation: conveyorMove 3s linear infinite;
    }
    .conveyor::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 100%;
      background-image: 
        repeating-linear-gradient(
          270deg,
          rgba(139,99,50,0.2) 0px,
          rgba(139,99,50,0.2) 20px,
          rgba(107,68,35,0.2) 20px,
          rgba(107,68,35,0.2) 40px
        );
      opacity: 0.6;
    }
    @keyframes conveyorMove {
      0% { background-position: 0 0; }
      100% { background-position: -45px 0; }
    }
    .sushi-container {
      position: absolute;
      bottom: 25px;
      left: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .sushi {
      font-size: 64px;
      filter: drop-shadow(0 3px 5px rgba(0,0,0,0.3));
      margin-bottom: -8px;
      z-index: 2;
    }
    .sushi-plate {
      width: 90px;
      height: 14px;
      background: linear-gradient(to bottom, #F5F5F5 0%, #E0E0E0 30%, #D0D0D0 60%, #C0C0C0 100%);
      border-radius: 50%;
      box-shadow: 0 4px 8px rgba(0,0,0,0.4), inset 0 1px 3px rgba(255,255,255,0.6);
      position: relative;
      z-index: 1;
    }
    .sushi-plate::before {
      content: "";
      position: absolute;
      top: 2px;
      left: 12%;
      right: 12%;
      height: 5px;
      background: linear-gradient(to bottom, rgba(255,255,255,0.7), transparent);
      border-radius: 50%;
    }
    .sushi-plate::after {
      content: "";
      position: absolute;
      bottom: -2px;
      left: 8%;
      right: 8%;
      height: 2px;
      background: radial-gradient(ellipse at center, rgba(0,0,0,0.25), transparent);
      border-radius: 50%;
    }
    .word-display {
      position: absolute;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      background: rgba(255,255,255,0.95);
      padding: 20px 40px;
      border-radius: 15px;
      border: 3px solid #ddd;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 10;
    }
    .japanese { font-size: 2.5rem; font-weight: bold; color: #333; }
    .romaji { font-family: monospace; font-size: 1.6rem; margin-top: 10px; }
    .typed { color: #4169E1; font-weight: bold; }
    .remaining { color: #ccc; }
    .game-footer {
      background: linear-gradient(to bottom, #F5F5F5, #E8E8E8);
      border-top: 5px solid #8B4513;
      padding: 15px;
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
    }
    .meter {
      width: 200px;
      height: 16px;
      background: #E5E5E5;
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid #999;
      margin: 5px auto;
    }
    .meter-fill {
      height: 100%;
      background: linear-gradient(to right, #FFD700, #FF6347);
      width: 0%;
      transition: width 0.3s;
    }
    .countdown-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .countdown-text {
      color: white;
      text-align: center;
    }
    .countdown-number {
      font-size: 6rem;
      font-weight: 900;
      text-shadow: 0 0 30px rgba(255,255,255,0.5);
    }
    .hidden { display: none; }
    .link { color: #4169E1; text-decoration: underline; cursor: pointer; }
    .link:hover { color: #2E4C99; }
    .result-box {
      border-radius: 10px;
      padding: 20px;
      margin: 15px 0;
      text-align: center;
    }
    .result-big { font-size: 3rem; font-weight: 800; }
    .shake { animation: shake 0.3s; }
    @keyframes shake {
      0%, 100% { transform: translateX(-50%) translateY(0); }
      25% { transform: translateX(-50%) translateY(-8px); }
      50% { transform: translateX(-50%) translateY(0); }
      75% { transform: translateX(-50%) translateY(-8px); }
    }
    @media(max-width: 768px) {
      h1 { font-size: 2.5rem; }
      .btn { padding: 10px 20px; font-size: 0.95rem; }
      .course-box { padding: 15px; }
      .game-header { padding: 10px; gap: 10px; }
      .game-header > div { min-width: 80px; }
      .belt { height: 250px; }
      .sushi { font-size: 48px; }
      .word-display { padding: 15px 25px; }
      .japanese { font-size: 2rem; }
      .romaji { font-size: 1.3rem; }
      .meter { width: 150px; height: 14px; }
      .countdown-number { font-size: 4rem; }
      .result-big { font-size: 2rem; }
      .game-footer { padding: 10px; font-size: 0.9rem; }
    }
    @media(max-width: 480px) {
      h1 { font-size: 2rem; }
      .subtitle { font-size: 0.85rem; }
      .btn { padding: 8px 16px; font-size: 0.9rem; }
      .course-box { padding: 12px; margin: 10px 0; }
      .course-box h3 { font-size: 1rem; }
      .mode-box { padding: 12px; margin: 8px 0; }
      .mode-box h3 { font-size: 1rem; }
      .game-header { 
        flex-direction: column; 
        align-items: stretch;
        padding: 8px;
      }
      .game-header > div { 
        text-align: center; 
        margin: 5px 0;
      }
      .belt { height: 220px; }
      .sushi { font-size: 40px; }
      .word-display { 
        padding: 12px 20px;
        top: 30px;
        left: 50%;
        right: auto;
        transform: translateX(-50%);
        max-width: calc(100% - 20px);
      }
      .japanese { font-size: 1.6rem; }
      .romaji { font-size: 1.1rem; margin-top: 8px; }
      .meter { width: 120px; height: 12px; }
      .countdown-number { font-size: 3rem; }
      #countdownMsg { font-size: 1.2rem; }
      .result-big { font-size: 1.5rem; }
      .result-box { padding: 15px; }
      .game-footer { 
        flex-direction: column; 
        padding: 8px;
        font-size: 0.85rem;
      }
      .game-footer > div { margin: 3px 0; }
    }
    @media(max-width: 360px) {
      h1 { font-size: 1.8rem; }
      .card { padding: 15px; }
      .japanese { font-size: 1.4rem; }
      .romaji { font-size: 1rem; }
      .sushi { font-size: 36px; }
      .belt { height: 200px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>å¯¿å¸æ‰“</h1>
    <p class="subtitle">Sushida - ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚²ãƒ¼ãƒ </p>

    <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ -->
    <div id="menu" class="card">
      <h2 style="text-align:center; color:#8B4513; margin-bottom:30px;">ğŸ£ ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ ğŸ£</h2>
      
      <div class="course-box" style="border-color:#90EE90; background:#F0FFF0;">
        <h3 style="color:#228B22;">ğŸŒ± ãŠæ‰‹è»½ 3,000å††ã‚³ãƒ¼ã‚¹</h3>
        <p style="color:#666; margin:10px 0;">æ–‡å­—æ•°2ã€œ7æ–‡å­—ã€åˆ¶é™æ™‚é–“60ç§’</p>
        <button class="btn btn-green" onclick="selectCourse('easy')">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      </div>

      <div class="course-box" style="border-color:#87CEEB; background:#F0F8FF;">
        <h3 style="color:#4169E1;">â­ ãŠå‹§ã‚ 5,000å††ã‚³ãƒ¼ã‚¹</h3>
        <p style="color:#666; margin:10px 0;">æ–‡å­—æ•°5ã€œ10æ–‡å­—ã€åˆ¶é™æ™‚é–“90ç§’</p>
        <button class="btn btn-blue" onclick="selectCourse('normal')">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      </div>

      <div class="course-box" style="border-color:#FFB6C1; background:#FFF0F5;">
        <h3 style="color:#DC143C;">ğŸ‘‘ é«˜ç´š 10,000å††ã‚³ãƒ¼ã‚¹</h3>
        <p style="color:#666; margin:10px 0;">æ–‡å­—æ•°9ã€œ14æ–‡å­—ä»¥ä¸Šã€åˆ¶é™æ™‚é–“120ç§’</p>
        <button class="btn btn-red" onclick="selectCourse('hard')">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ -->
    <div id="modeSelect" class="card hidden">
      <h2 style="text-align:center; color:#8B4513; margin-bottom:20px;">ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
      <p id="courseName" style="text-align:center; color:#666; margin-bottom:30px;"></p>
      
      <div id="modeList"></div>
      
      <div style="text-align:center; margin-top:20px;">
        <span class="link" onclick="showScreen('menu')">â† ã‚³ãƒ¼ã‚¹é¸æŠã«æˆ»ã‚‹</span>
      </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
    <div id="game" class="card hidden" style="padding:0; overflow:hidden; position:relative;">
      <div id="countdownOverlay" class="countdown-overlay hidden">
        <div class="countdown-text">
          <div id="countdownMsg" style="font-size:1.5rem; margin-bottom:20px;">ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ</div>
          <div id="countdownNum" class="countdown-number">SPACE</div>
        </div>
      </div>

      <div class="game-header">
        <div>
          <div style="color:#8B4513; font-weight:bold;">ç²å¾—:</div>
          <div id="score" style="color:#4169E1; font-weight:800; font-size:1.5rem;">0å††</div>
        </div>
        <div style="text-align:center;">
          <div style="color:#8B4513; font-size:0.85rem;">é€£æ‰“ãƒ¡ãƒ¼ã‚¿ãƒ¼</div>
          <div class="meter"><div id="meterFill" class="meter-fill"></div></div>
          <div id="combo" style="color:#666; font-size:0.9rem;">ã‚³ãƒ³ãƒœ: 0</div>
        </div>
        <div style="text-align:right;">
          <div style="color:#8B4513; font-weight:bold;">æ®‹ã‚Š:</div>
          <div id="timeLeft" style="color:#DC143C; font-weight:800; font-size:1.5rem;">0ç§’</div>
        </div>
      </div>

      <div class="belt">
        <div class="word-display" id="wordDisplay">
          <div id="japaneseWord" class="japanese">---</div>
          <div class="romaji">
            <span id="typedText" class="typed"></span><span id="remainingText" class="remaining"></span>
          </div>
        </div>
        <div class="conveyor">
          <div id="sushiContainer" class="sushi-container">
            <div id="sushi" class="sushi">ğŸ£</div>
            <div class="sushi-plate"></div>
          </div>
        </div>
      </div>

      <div class="game-footer">
        <div>æ­£è§£: <strong id="correct" style="color:#228B22;">0çš¿</strong></div>
        <div>ãƒŸã‚¹: <strong id="miss" style="color:#DC143C;">0å›</strong></div>
        <div>å˜ä¾¡: <strong id="price">0å††</strong></div>
        <div id="modeName" style="color:#666;">-</div>
      </div>
    </div>

    <!-- çµæœç”»é¢ -->
    <div id="result" class="card hidden">
      <h2 style="text-align:center; color:#8B4513; margin-bottom:20px;">ğŸŠ çµæœç™ºè¡¨ ğŸŠ</h2>
      <p id="resultSub" style="text-align:center; color:#666; margin-bottom:30px;"></p>

      <div class="result-box" style="border:3px solid #87CEEB; background:#F0F8FF;">
        <div style="color:#666;">ç²å¾—é‡‘é¡</div>
        <div id="resultScore" class="result-big" style="color:#4169E1;">0å††</div>
      </div>

      <div class="result-box" style="border:3px solid #FFB347; background:#FFF8DC;">
        <div style="color:#666;">ãŠä¼šè¨ˆ</div>
        <div id="resultCost" class="result-big" style="color:#FF8C00;">0å††</div>
      </div>

      <div id="profitBox" class="result-box"></div>

      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin:20px 0;">
        <div style="border:2px solid #ddd; border-radius:8px; padding:15px; text-align:center; background:#fafafa;">
          <div style="color:#666;">æ­£è§£æ•°</div>
          <div id="resultCorrect" style="font-size:2rem; color:#228B22; font-weight:800;">0çš¿</div>
        </div>
        <div style="border:2px solid #ddd; border-radius:8px; padding:15px; text-align:center; background:#fafafa;">
          <div style="color:#666;">ãƒŸã‚¹æ•°</div>
          <div id="resultMiss" style="font-size:2rem; color:#DC143C; font-weight:800;">0å›</div>
        </div>
        <div style="border:2px solid #ddd; border-radius:8px; padding:15px; text-align:center; background:#fafafa;">
          <div style="color:#666;">æ­£ç¢ºç‡</div>
          <div id="resultAccuracy" style="font-size:2rem; color:#4169E1; font-weight:800;">0%</div>
        </div>
      </div>

      <div style="text-align:center; margin-top:30px;">
        <button class="btn btn-brown" onclick="showScreen('menu')" style="padding:14px 28px; font-size:1.1rem;">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
      </div>
    </div>

    <div style="text-align:center; color:#666; margin-top:20px;">
      <p>â€»ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§æ–‡å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
      <p style="font-size:0.9rem; margin-top:5px;">Escã‚­ãƒ¼ã§ä¸­æ–­</p>
    </div>
  </div>

  <script>
    // ãƒ­ãƒ¼ãƒå­—å¤‰æ›ãƒãƒƒãƒ—
    const kanaToRomaji = {
      'ã‚':['a'],'ã„':['i'],'ã†':['u'],'ãˆ':['e'],'ãŠ':['o'],
      'ã‹':['ka','ca'],'ã':['ki'],'ã':['ku','cu'],'ã‘':['ke'],'ã“':['ko','co'],
      'ãŒ':['ga'],'ã':['gi'],'ã':['gu'],'ã’':['ge'],'ã”':['go'],
      'ã•':['sa'],'ã—':['si','shi','ci'],'ã™':['su'],'ã›':['se'],'ã':['so'],
      'ã–':['za'],'ã˜':['zi','ji'],'ãš':['zu'],'ãœ':['ze'],'ã':['zo'],
      'ãŸ':['ta'],'ã¡':['ti','chi'],'ã¤':['tu','tsu'],'ã¦':['te'],'ã¨':['to'],
      'ã ':['da'],'ã¢':['di'],'ã¥':['du'],'ã§':['de'],'ã©':['do'],
      'ãª':['na'],'ã«':['ni'],'ã¬':['nu'],'ã­':['ne'],'ã®':['no'],
      'ã¯':['ha'],'ã²':['hi'],'ãµ':['hu','fu'],'ã¸':['he'],'ã»':['ho'],
      'ã°':['ba'],'ã³':['bi'],'ã¶':['bu'],'ã¹':['be'],'ã¼':['bo'],
      'ã±':['pa'],'ã´':['pi'],'ã·':['pu'],'ãº':['pe'],'ã½':['po'],
      'ã¾':['ma'],'ã¿':['mi'],'ã‚€':['mu'],'ã‚':['me'],'ã‚‚':['mo'],
      'ã‚„':['ya'],'ã‚†':['yu'],'ã‚ˆ':['yo'],
      'ã‚‰':['ra'],'ã‚Š':['ri'],'ã‚‹':['ru'],'ã‚Œ':['re'],'ã‚':['ro'],
      'ã‚':['wa'],'ã‚’':['wo','o'],'ã‚“':['n','nn','xn'],
      'ã£':['ltu','xtu','ltsu'],
      'ãã‚ƒ':['kya'],'ãã‚…':['kyu'],'ãã‚‡':['kyo'],
      'ã—ã‚ƒ':['sya','sha'],'ã—ã‚…':['syu','shu'],'ã—ã‚‡':['syo','sho'],
      'ã¡ã‚ƒ':['tya','cha','cya'],'ã¡ã‚…':['tyu','chu','cyu'],'ã¡ã‚‡':['tyo','cho','cyo'],
      'ã«ã‚ƒ':['nya'],'ã«ã‚…':['nyu'],'ã«ã‚‡':['nyo'],
      'ã²ã‚ƒ':['hya'],'ã²ã‚…':['hyu'],'ã²ã‚‡':['hyo'],
      'ã¿ã‚ƒ':['mya'],'ã¿ã‚…':['myu'],'ã¿ã‚‡':['myo'],
      'ã‚Šã‚ƒ':['rya'],'ã‚Šã‚…':['ryu'],'ã‚Šã‚‡':['ryo'],
      'ãã‚ƒ':['gya'],'ãã‚…':['gyu'],'ãã‚‡':['gyo'],
      'ã˜ã‚ƒ':['ja','jya','zya'],'ã˜ã‚…':['ju','jyu','zyu'],'ã˜ã‚‡':['jo','jyo','zyo'],
      'ã³ã‚ƒ':['bya'],'ã³ã‚…':['byu'],'ã³ã‚‡':['byo'],
      'ã´ã‚ƒ':['pya'],'ã´ã‚…':['pyu'],'ã´ã‚‡':['pyo']
    };

    // å˜èªãƒ‡ãƒ¼ã‚¿
    const words = {
      easy: [
        {japanese:'ã¾ãã‚',kana:'ã¾ãã‚',price:120},
        {japanese:'ã•ã‘',kana:'ã•ã‘',price:100},
        {japanese:'ãŸã¾ã”',kana:'ãŸã¾ã”',price:140},
        {japanese:'ã„ã‹',kana:'ã„ã‹',price:100},
        {japanese:'ãˆã³',kana:'ãˆã³',price:100},
        {japanese:'ã†ã«',kana:'ã†ã«',price:150},
        {japanese:'ã„ãã‚‰',kana:'ã„ãã‚‰',price:120},
        {japanese:'ã‚ã˜',kana:'ã‚ã˜',price:100},
        {japanese:'ã•ã°',kana:'ã•ã°',price:100},
        {japanese:'ãŸã“',kana:'ãŸã“',price:100}
      ],
      normal: [
        {japanese:'ãŠã„ã—ã„',kana:'ãŠã„ã—ã„',price:280},
        {japanese:'ã‚ã‚ŠãŒã¨ã†',kana:'ã‚ã‚ŠãŒã¨ã†',price:320},
        {japanese:'ã—ã‚“ã›ã‚“',kana:'ã—ã‚“ã›ã‚“',price:280},
        {japanese:'ã™ã—ã‚„',kana:'ã™ã—ã‚„',price:260},
        {japanese:'ã‹ã„ã¦ã‚“',kana:'ã‹ã„ã¦ã‚“',price:280},
        {japanese:'ãŠã¡ã‚ƒ',kana:'ãŠã¡ã‚ƒ',price:200},
        {japanese:'ã‚ã•ã³',kana:'ã‚ã•ã³',price:240},
        {japanese:'ã—ã‚‡ã†ãŒ',kana:'ã—ã‚‡ã†ãŒ',price:280},
        {japanese:'ãŠã¦ãµã',kana:'ãŠã¦ãµã',price:280},
        {japanese:'ã»ãŸã¦ãŒã„',kana:'ã»ãŸã¦ãŒã„',price:360}
      ],
      hard: [
        {japanese:'ãŠãŠã¨ã‚',kana:'ãŠãŠã¨ã‚',price:480},
        {japanese:'ã—ã‚ƒã‚ŠãŒãŠã„ã—ã„',kana:'ã—ã‚ƒã‚ŠãŒãŠã„ã—ã„',price:640},
        {japanese:'ã‹ã„ã¦ã‚“ãšã—',kana:'ã‹ã„ã¦ã‚“ãšã—',price:560},
        {japanese:'ã‚ã¶ã‚Šã‚µãƒ¼ãƒ¢ãƒ³',kana:'ã‚ã¶ã‚Šã•ãƒ¼ã‚‚ã‚“',price:600},
        {japanese:'ã„ãã‚‰ãã‚“ã‹ã‚“',kana:'ã„ãã‚‰ãã‚“ã‹ã‚“',price:600},
        {japanese:'ã¡ã‚…ã†ã¨ã‚',kana:'ã¡ã‚…ã†ã¨ã‚',price:520},
        {japanese:'ãˆã‚“ãŒã‚',kana:'ãˆã‚“ãŒã‚',price:480},
        {japanese:'ã‹ã‚“ã±ã¡',kana:'ã‹ã‚“ã±ã¡',price:480},
        {japanese:'ã¶ã‚Šã¨ã‚',kana:'ã¶ã‚Šã¨ã‚',price:480},
        {japanese:'ã»ãŸã¦ã®ã«ãã‚Š',kana:'ã»ãŸã¦ã®ã«ãã‚Š',price:680}
      ]
    };

    const courses = {
      easy: {name:'ãŠæ‰‹è»½3,000å††ã‚³ãƒ¼ã‚¹', time:60, cost:3000},
      normal: {name:'ãŠå‹§ã‚5,000å††ã‚³ãƒ¼ã‚¹', time:90, cost:5000},
      hard: {name:'é«˜ç´š10,000å††ã‚³ãƒ¼ã‚¹', time:120, cost:10000}
    };

    const modes = {
      practice: {name:'ç·´ç¿’', speed:0.5, desc:'æ™®é€šã‚ˆã‚Šã‚¹ãƒ”ãƒ¼ãƒ‰ãŒé…ã„ã€‚åˆ¶é™æ™‚é–“ãŒ0ã«ãªã£ãŸã‚‰çµ‚äº†ã€‚'},
      normal: {name:'æ™®é€š', speed:0.8, desc:'æ™®é€šã®ã‚¹ãƒ”ãƒ¼ãƒ‰ã€‚åˆ¶é™æ™‚é–“ãŒ0ã«ãªã£ãŸã‚‰çµ‚äº†ã€‚'},
      accuracy: {name:'æ­£ç¢ºé‡è¦–', speed:0.8, desc:'ãƒŸã‚¹ã‚¿ã‚¤ãƒ—ã‚’ã™ã‚‹ã¨ã€ã‚¿ã‚¤ãƒ—ä¸­ã®ãŠçš¿ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã€æ–°ã—ã„çš¿ã«ãªã‚‹ã€‚'},
      speed: {name:'é€Ÿåº¦å¿…é ˆ', speed:1.0, desc:'1åº¦ã§ã‚‚ãŠçš¿ãŒç”»é¢å¤–ã«æµã‚Œã¦ã„ãã‹ã€åˆ¶é™æ™‚é–“ãŒ0ã«ãªã£ãŸã‚‰çµ‚äº†ã€‚'},
      oneshot: {name:'ä¸€ç™ºå‹è² ', speed:0.8, desc:'ãƒŸã‚¹ã‚¿ã‚¤ãƒ—ã‚’ã—ãŸã‚Šã€ãŠçš¿ãŒç”»é¢å¤–ã«æµã‚Œã¦ã„ãã¨ã€ãã®å ´ã§çµ‚äº†ã€‚'}
    };

    // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
    let state = {
      course: 'normal',
      mode: 'normal',
      word: null,
      patterns: [],
      paths: [],
      typed: '',
      score: 0,
      time: 90,
      correct: 0,
      miss: 0,
      combo: 0,
      totalKeys: 0,
      sushiPos: 100,
      timerId: null,
      moveId: null,
      countId: null,
      waiting: false,
      keyHandler: null
    };

    // ã²ã‚‰ãŒãªã‚’ãƒ­ãƒ¼ãƒå­—ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¤‰æ›
    function kanaToPatterns(kana) {
      const result = [];
      let i = 0;
      while (i < kana.length) {
        const two = kana.substring(i, i + 2);
        const one = kana[i];
        
        // é•·éŸ³ç¬¦ã€Œãƒ¼ã€ã®å‡¦ç†
        if (one === 'ãƒ¼') {
          result.push(['-']);
          i++;
        } else if (kanaToRomaji[two]) {
          result.push(kanaToRomaji[two]);
          i += 2;
        } else if (kanaToRomaji[one]) {
          result.push(kanaToRomaji[one]);
          i++;
        } else {
          result.push([one]);
          i++;
        }
      }
      return result;
    }

    // æ®‹ã‚Šã®ãƒ­ãƒ¼ãƒå­—ã‚’å–å¾—
    function getRemaining() {
      if (!state.paths || state.paths.length === 0 || !state.patterns) return '';
      let shortest = null;
      for (let path of state.paths) {
        let rem = '';
        for (let i = path.pos; i < state.patterns.length; i++) {
          const opts = state.patterns[i];
          if (!opts || opts.length === 0) continue;
          if (i === path.pos) {
            const match = opts.find(o => o.startsWith(path.partial));
            let text = (match || opts[0]).slice(path.partial.length);
            
            // ã€Œã‚“ã€ãŒæœ€å¾Œã®ä½ç½®ã§ã€é¸æŠè‚¢ã«'n'ãŒå«ã¾ã‚Œã‚‹å ´åˆã¯'nn'ã‚’å„ªå…ˆè¡¨ç¤º
            if (i === state.patterns.length - 1 && opts.includes('n') && opts.includes('nn')) {
              if (path.partial === '') {
                text = 'nn';
              } else if (path.partial === 'n') {
                text = 'n';
              }
            }
            
            rem += text;
          } else {
            // ã€Œã‚“ã€ãŒæœ€å¾Œã®ä½ç½®ã®å ´åˆã¯'nn'ã‚’å„ªå…ˆè¡¨ç¤º
            if (i === state.patterns.length - 1 && opts.includes('n') && opts.includes('nn')) {
              rem += 'nn';
            } else {
              rem += opts[0];
            }
          }
        }
        if (!shortest || rem.length < shortest.length) shortest = rem;
      }
      return shortest || '';
    }

    // UIæ›´æ–°
    function updateUI() {
      document.getElementById('japaneseWord').textContent = state.word ? state.word.japanese : '---';
      document.getElementById('typedText').textContent = state.typed;
      document.getElementById('remainingText').textContent = getRemaining();
      document.getElementById('score').textContent = state.score + 'å††';
      document.getElementById('timeLeft').textContent = state.time + 'ç§’';
      document.getElementById('correct').textContent = state.correct + 'çš¿';
      document.getElementById('miss').textContent = state.miss + 'å›';
      document.getElementById('combo').textContent = 'ã‚³ãƒ³ãƒœ: ' + state.combo;
      const meter = Math.min((state.combo % 10) * 10, 100);
      document.getElementById('meterFill').style.width = meter + '%';
      if (state.word) {
        document.getElementById('price').textContent = state.word.price + 'å††';
      }
    }

    // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
    function showScreen(screen) {
      document.getElementById('menu').classList.add('hidden');
      document.getElementById('modeSelect').classList.add('hidden');
      document.getElementById('game').classList.add('hidden');
      document.getElementById('result').classList.add('hidden');
      document.getElementById(screen).classList.remove('hidden');
    }

    // ã‚³ãƒ¼ã‚¹é¸æŠ
    function selectCourse(course) {
      state.course = course;
      document.getElementById('courseName').textContent = courses[course].name;
      
      const list = document.getElementById('modeList');
      list.innerHTML = '';
      for (let key in modes) {
        const m = modes[key];
        const box = document.createElement('div');
        box.className = 'mode-box';
        box.innerHTML = `
          <h3 style="margin:0 0 10px 0; color:#333;">${m.name}</h3>
          <p style="color:#666; margin:0 0 15px 0; font-size:0.9rem;">${m.desc}</p>
          <button class="btn btn-brown" onclick="startGame('${key}')">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        `;
        list.appendChild(box);
      }
      
      showScreen('modeSelect');
    }

    // æ–°ã—ã„å˜èªã‚’ã‚»ãƒƒãƒˆ
    function setWord() {
      const list = words[state.course];
      state.word = list[Math.floor(Math.random() * list.length)];
      state.patterns = kanaToPatterns(state.word.kana);
      state.paths = [{pos: 0, partial: ''}];
      state.typed = '';
      state.sushiPos = 100;
      const container = document.getElementById('sushiContainer');
      if (container) container.style.left = '100%';
      updateUI();
    }

    // ã‚²ãƒ¼ãƒ é–‹å§‹
    function startGame(mode) {
      // å‰å›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
      if (state.keyHandler) {
        document.removeEventListener('keydown', state.keyHandler);
      }
      
      state.mode = mode;
      state.score = 0;
      state.time = courses[state.course].time;
      state.correct = 0;
      state.miss = 0;
      state.combo = 0;
      state.totalKeys = 0;
      
      setWord();
      showScreen('game');
      
      document.getElementById('modeName').textContent = modes[mode].name + 'ãƒ¢ãƒ¼ãƒ‰';
      document.getElementById('countdownOverlay').classList.remove('hidden');
      document.getElementById('countdownNum').textContent = 'SPACE';
      document.getElementById('countdownMsg').textContent = 'ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ';
      
      state.waiting = true;
      
      const waitHandler = (e) => {
        if (e.code === 'Space' && state.waiting) {
          e.preventDefault();
          document.removeEventListener('keydown', waitHandler);
          startCountdown();
        }
      };
      document.addEventListener('keydown', waitHandler);
    }

    // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
    function startCountdown() {
      let count = 3;
      document.getElementById('countdownNum').textContent = count;
      document.getElementById('countdownMsg').textContent = 'ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼';
      state.waiting = false;
      
      state.countId = setInterval(() => {
        count--;
        if (count > 0) {
          document.getElementById('countdownNum').textContent = count;
        } else {
          clearInterval(state.countId);
          document.getElementById('countdownOverlay').classList.add('hidden');
          startPlay();
        }
      }, 1000);
    }

    // ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤é–‹å§‹
    function startPlay() {
      state.sushiPos = 100;
      const container = document.getElementById('sushiContainer');
      if (container) container.style.left = '100%';
      
      // ã‚¿ã‚¤ãƒãƒ¼
      state.timerId = setInterval(() => {
        state.time--;
        updateUI();
        if (state.time <= 0) {
          endGame();
        }
      }, 1000);
      
      // å¯¿å¸ç§»å‹•
      const speed = modes[state.mode].speed;
      state.moveId = setInterval(() => {
        state.sushiPos -= speed;
        if (container) container.style.left = state.sushiPos + '%';
        if (state.sushiPos <= -20) {
          missedSushi();
        }
      }, 50);
      
      // ã‚­ãƒ¼å…¥åŠ›
      state.keyHandler = handleKey;
      document.addEventListener('keydown', state.keyHandler);
    }

    // ã‚­ãƒ¼å…¥åŠ›å‡¦ç†
    function handleKey(e) {
      // Escapeã‚­ãƒ¼ã§ä¸­æ–­
      if (e.key === 'Escape') {
        e.preventDefault();
        endGame();
        return;
      }
      
      if (!e.key || !e.key.match(/^[a-z\-]$/i)) return;
      e.preventDefault();
      
      const key = e.key.toLowerCase();
      state.totalKeys++;
      
      const newPaths = [];
      for (let path of state.paths) {
        if (path.pos >= state.patterns.length) continue;
        const opts = state.patterns[path.pos];
        if (!opts) continue;
        const test = path.partial + key;
        for (let opt of opts) {
          if (opt.startsWith(test)) {
            if (test === opt) {
              newPaths.push({pos: path.pos + 1, partial: ''});
            } else {
              newPaths.push({pos: path.pos, partial: test});
            }
          }
        }
      }
      
      if (newPaths.length > 0) {
        state.paths = newPaths;
        state.typed += key;
        state.combo++;
        
        if (state.combo > 0 && state.combo % 10 === 0) {
          state.time += 2;
        }
        
        const complete = state.paths.every(p => p.pos >= state.patterns.length);
        if (complete) {
          state.score += state.word.price;
          state.correct++;
          state.sushiPos = 100;
          setWord();
        }
        updateUI();
      } else {
        handleMiss();
      }
    }

    // ãƒŸã‚¹å‡¦ç†
    function handleMiss() {
      state.miss++;
      state.combo = 0;
      const box = document.getElementById('wordDisplay');
      if (box) {
        box.classList.add('shake');
        setTimeout(() => box.classList.remove('shake'), 300);
      }
      
      if (state.mode === 'accuracy') {
        state.sushiPos = 100;
        setWord();
      } else if (state.mode === 'oneshot') {
        endGame();
      }
      updateUI();
    }

    // å¯¿å¸ãŒæµã‚ŒãŸ
    function missedSushi() {
      state.miss++;
      state.combo = 0;
      
      if (state.mode === 'speed' || state.mode === 'oneshot') {
        endGame();
      } else {
        state.sushiPos = 100;
        setWord();
      }
    }

    // ã‚²ãƒ¼ãƒ çµ‚äº†
    function endGame() {
      if (state.timerId) {
        clearInterval(state.timerId);
        state.timerId = null;
      }
      if (state.moveId) {
        clearInterval(state.moveId);
        state.moveId = null;
      }
      if (state.countId) {
        clearInterval(state.countId);
        state.countId = null;
      }
      if (state.keyHandler) {
        document.removeEventListener('keydown', state.keyHandler);
        state.keyHandler = null;
      }
      
      const cost = courses[state.course].cost;
      const profit = state.score - cost;
      const accuracy = state.totalKeys > 0 ? Math.round((state.totalKeys - state.miss) / state.totalKeys * 100) : 0;
      
      document.getElementById('resultSub').textContent = courses[state.course].name + ' - ' + modes[state.mode].name + 'ãƒ¢ãƒ¼ãƒ‰';
      document.getElementById('resultScore').textContent = state.score + 'å††';
      document.getElementById('resultCost').textContent = cost + 'å††';
      document.getElementById('resultCorrect').textContent = state.correct + 'çš¿';
      document.getElementById('resultMiss').textContent = state.miss + 'å›';
      document.getElementById('resultAccuracy').textContent = accuracy + '%';
      
      const profitBox = document.getElementById('profitBox');
      if (profit >= 0) {
        profitBox.style.border = '5px solid #90EE90';
        profitBox.style.background = '#F0FFF0';
        profitBox.innerHTML = `
          <div style="color:#666;">ãŠå¾—é¡</div>
          <div class="result-big" style="color:#228B22;">+${profit}å††</div>
          <div style="margin-top:10px; font-size:1.2rem; font-weight:bold; color:#228B22;">ğŸ‰ å…ƒãŒå–ã‚Œã¾ã—ãŸ!</div>
        `;
      } else {
        profitBox.style.border = '5px solid #FFB6C1';
        profitBox.style.background = '#FFF0F5';
        profitBox.innerHTML = `
          <div style="color:#666;">ãŠå¾—é¡</div>
          <div class="result-big" style="color:#DC143C;">${profit}å††</div>
          <div style="margin-top:10px; color:#DC143C;">æ¬¡å›é ‘å¼µã‚Šã¾ã—ã‚‡ã†!</div>
        `;
      }
      
      showScreen('result');
    }

    // åˆæœŸè¡¨ç¤º
    showScreen('menu');
  </script>
</body>
</html>
