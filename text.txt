<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¯¿å¸æ‰“ - Typing Game</title>
  <style>
    :root{
      --brown:#8B4513;
      --light-brown:#CD853F;
      --accent:#4169E1;
    }
    html,body{height:100%;margin:0;font-family:"Noto Sans JP","Arial",sans-serif;background:linear-gradient(to bottom, #fff8dc 0%, #ffe4b5 100%);}
    .container{max-width:960px;margin:24px auto;padding:24px;}
    .card{background:#fff;border:5px solid var(--brown);border-radius:10px;padding:28px;box-shadow:0 8px 16px rgba(0,0,0,0.1);}
    h1{font-size:4rem;margin:0;color:var(--light-brown);text-shadow:4px 4px 0 #fff,8px 8px 0 #8B4513;letter-spacing:2px;font-weight:900;animation:float 3s ease-in-out infinite;}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
    .muted{color:#666;font-size:0.9rem}
    .center{text-align:center}
    .btn{display:inline-block;padding:12px 24px;border-radius:8px;border:none;font-weight:700;cursor:pointer;transition:all 0.3s ease;transform:scale(1);}
    .btn:hover{transform:scale(1.05);box-shadow:0 4px 12px rgba(0,0,0,0.2);}
    .btn:active{transform:scale(0.95);}
    .btn-green{background:#32CD32;color:#fff}
    .btn-blue{background:#4169E1;color:#fff}
    .btn-red{background:#DC143C;color:#fff}
    .space-y > * + *{margin-top:1rem}
    .course-box{padding:18px;border-radius:8px;transition:transform 0.3s ease,box-shadow 0.3s ease;}
    .course-box:hover{transform:translateY(-5px);box-shadow:0 8px 16px rgba(0,0,0,0.15);}
    .mode-box{padding:16px;border-radius:6px;border:2px solid #D3D3D3;background:#FAFAFA;margin-bottom:12px;transition:all 0.3s ease;}
    .mode-box:hover{border-color:var(--accent);background:#F5F5FF;}
    .game-top{background:linear-gradient(to bottom,#FFEFD5,#FFE4B5);border-bottom:5px solid var(--brown);padding:12px}
    .belt{position:relative;height:280px;background:linear-gradient(to bottom,#87CEEB 0%, #E0F6FF 100%);overflow:hidden}
    .conveyor{position:absolute;bottom:0;left:0;right:0;height:100px;background:linear-gradient(to bottom,#8B4513 0%, #654321 50%, #3E2723 100%);border-top:5px solid #5D4037}
    .conveyor::before{content:"";position:absolute;inset:0;background-image:repeating-linear-gradient(90deg,transparent,transparent 40px, rgba(255,255,255,0.07) 40px, rgba(255,255,255,0.07) 42px);animation:scroll 2s linear infinite;}
    @keyframes scroll{0%{background-position:0 0}100%{background-position:40px 0}}
    .sushi{position:absolute;top:50%;transform:translateY(-50%);font-size:64px;left:100%;transition:font-size 0.1s ease;}
    .sushi.correct{animation:bounce 0.3s ease;}
    @keyframes bounce{0%,100%{transform:translateY(-50%) scale(1)}50%{transform:translateY(-50%) scale(1.3)}}
    .speech{position:absolute;top:30px;left:0;right:0;text-align:center}
    .speech .box{display:inline-block;padding:20px 40px;border-radius:15px;border:3px solid #DDD;background:rgba(255,255,255,0.95);box-shadow:0 4px 6px rgba(0,0,0,0.1)}
    .typed{font-family:monospace;font-size:2rem}
    .bottom-info{background:linear-gradient(to bottom,#F5F5F5,#E8E8E8);border-top:5px solid var(--brown);padding:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .result-big{font-size:3rem;font-weight:800}
    .meter{width:200px;height:16px;background:#E5E5E5;border-radius:8px;overflow:hidden;border:2px solid #999}
    .meter-inner{height:100%;background:linear-gradient(to right,#FFD700,#FF6347);width:0%;transition:width 0.3s ease;}
    .link{color:#4169E1;text-decoration:underline;cursor:pointer;transition:color 0.3s ease;}
    .link:hover{color:#2E4C99;}
    .footer{margin-top:16px;text-align:center;color:#666;font-size:.9rem}
    .particle{position:absolute;font-size:24px;pointer-events:none;animation:particle-float 1s ease-out forwards;}
    @keyframes particle-float{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-100px)}}
    .shake{animation:shake 0.3s ease;}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-10px)}75%{transform:translateX(10px)}}
    .time-warning{animation:pulse 1s ease-in-out infinite;}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
    @media(max-width:520px){
      h1{font-size:2.4rem}
      .speech .box{padding:12px 18px}
      .sushi{font-size:48px}
      .meter{width:150px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="app">
      <div class="center">
        <h1>å¯¿å¸æ‰“</h1>
        <p class="muted">Sushida - ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚²ãƒ¼ãƒ </p>
      </div>

      <div id="menu" class="card" style="margin-top:16px">
        <h2 class="center" style="font-size:1.6rem;color:var(--brown)">ğŸ£ ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ ğŸ£</h2>

        <div class="space-y" style="margin-top:18px;max-width:720px;margin-left:auto;margin-right:auto">
          <div class="course-box" style="border:3px solid #90EE90;background:#F0FFF0">
            <h3 style="color:#228B22;margin:0;font-size:1.2rem">ğŸŒ± ãŠæ‰‹è»½ 3,000å††ã‚³ãƒ¼ã‚¹</h3>
            <p class="muted">æ–‡å­—æ•°2ã€œ7æ–‡å­—ã€åˆ¶é™æ™‚é–“60ç§’</p>
            <button class="btn btn-green" id="start-easy">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
          </div>

          <div class="course-box" style="border:3px solid #87CEEB;background:#F0F8FF">
            <h3 style="color:#4169E1;margin:0;font-size:1.2rem">â­ ãŠå‹§ã‚ 5,000å††ã‚³ãƒ¼ã‚¹</h3>
            <p class="muted">æ–‡å­—æ•°5ã€œ10æ–‡å­—ã€åˆ¶é™æ™‚é–“90ç§’</p>
            <button class="btn btn-blue" id="start-normal">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
          </div>

          <div class="course-box" style="border:3px solid #FFB6C1;background:#FFF0F5">
            <h3 style="color:#DC143C;margin:0;font-size:1.2rem">ğŸ‘‘ é«˜ç´š 10,000å††ã‚³ãƒ¼ã‚¹</h3>
            <p class="muted">æ–‡å­—æ•°9ã€œ14æ–‡å­—ä»¥ä¸Šã€åˆ¶é™æ™‚é–“120ç§’</p>
            <button class="btn btn-red" id="start-hard">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
          </div>
        </div>
      </div>

      <div id="mode-select" class="card" style="display:none;margin-top:16px">
        <h2 class="center" style="font-size:1.6rem;color:var(--brown)">ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
        <p class="center muted" id="selected-course-name" style="margin-top:6px"></p>

        <div style="max-width:720px;margin:16px auto">
          <div id="modes-container"></div>

          <div class="center" style="margin-top:12px">
            <span class="link" id="back-to-course">â† ã‚³ãƒ¼ã‚¹é¸æŠã«æˆ»ã‚‹</span>
          </div>
        </div>
      </div>

      <div id="playing" class="card" style="display:none;margin-top:16px;padding:0;overflow:hidden">
        <div class="game-top">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
            <div>
              <div style="color:var(--brown);font-weight:700">ç²å¾—:</div>
              <div style="color:var(--accent);font-weight:800;font-size:1.6rem" id="score">0å††</div>
            </div>

            <div style="text-align:center">
              <div style="color:var(--brown);font-size:0.8rem">é€£æ‰“ãƒ¡ãƒ¼ã‚¿ãƒ¼</div>
              <div class="meter" style="margin:auto">
                <div class="meter-inner" id="meter-inner"></div>
              </div>
              <div class="muted" id="combo">ã‚³ãƒ³ãƒœ: 0</div>
            </div>

            <div style="text-align:right">
              <div style="color:var(--brown);font-weight:700">æ®‹ã‚Š:</div>
              <div style="color:#DC143C;font-weight:800;font-size:1.6rem" id="time-left">0ç§’</div>
            </div>
          </div>
        </div>

        <div class="belt" id="belt">
          <div class="speech">
            <div class="box" id="speech-box">
              <div class="typed" id="japanese-word" style="font-size:2.5rem;font-weight:800;color:#333">---</div>
              <div style="font-family:monospace;font-size:1.6rem;margin-top:8px">
                <span style="color:var(--accent);font-weight:800" id="typed-text"></span><span id="remaining-romaji" style="color:#CCC"></span>
              </div>
            </div>
          </div>

          <div class="conveyor">
            <div id="sushi" class="sushi">ğŸ£</div>
          </div>
        </div>

        <div class="bottom-info">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
            <div>æ­£è§£: <strong id="correct-count" style="color:#228B22">0çš¿</strong></div>
            <div>ãƒŸã‚¹: <strong id="miss-count" style="color:#DC143C">0å›</strong></div>
            <div>å˜ä¾¡: <strong id="unit-price">0å††</strong></div>
            <div id="mode-name" class="muted">-</div>
          </div>
        </div>
      </div>

      <div id="result" class="card" style="display:none;margin-top:16px">
        <h2 class="center" style="font-size:2rem;color:var(--brown)">ğŸŠ çµæœç™ºè¡¨ ğŸŠ</h2>
        <p class="center muted" id="result-sub"></p>

        <div style="max-width:720px;margin:20px auto" id="result-body">
          <div style="border:3px solid #87CEEB;background:#F0F8FF;border-radius:10px;padding:18px;margin-bottom:12px;text-align:center">
            <div class="muted">ç²å¾—é‡‘é¡</div>
            <div class="result-big" id="result-score" style="color:var(--accent)">0å††</div>
          </div>

          <div style="border:3px solid #FFB347;background:#FFF8DC;border-radius:10px;padding:18px;margin-bottom:12px;text-align:center">
            <div class="muted">ãŠä¼šè¨ˆ</div>
            <div class="result-big" id="result-cost" style="color:#FF8C00">0å††</div>
          </div>

          <div id="profit-box" style="border-radius:10px;padding:24px;margin-bottom:12px;text-align:center"></div>

          <div class="grid">
            <div style="border:2px solid #DDD;background:#FAFAFA;border-radius:8px;padding:16px;text-align:center">
              <div class="muted">æ­£è§£æ•°</div>
              <div style="font-size:2rem;color:#228B22;font-weight:800" id="result-correct">0çš¿</div>
            </div>
            <div style="border:2px solid #DDD;background:#FAFAFA;border-radius:8px;padding:16px;text-align:center">
              <div class="muted">ãƒŸã‚¹æ•°</div>
              <div style="font-size:2rem;color:#DC143C;font-weight:800" id="result-miss">0å›</div>
            </div>
          </div>

          <div style="border:2px solid #DDD;background:#FAFAFA;border-radius:8px;padding:16px;text-align:center;margin-top:12px;">
            <div class="muted">æ­£ç¢ºç‡</div>
            <div style="font-size:2rem;color:#4169E1;font-weight:800" id="result-accuracy">0%</div>
          </div>
        </div>

        <div class="center" style="margin-top:12px">
          <button class="btn" id="back-to-menu" style="background:var(--light-brown);color:#fff;padding:14px 28px;border-radius:10px">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
        </div>
      </div>

      <div class="footer">
        <p>â€»ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§æ–‡å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
      </div>
    </div>
  </div>

  <script>
    // ãƒ­ãƒ¼ãƒå­—ãƒãƒƒãƒ—
    const romajiMap = {
      'ã‚': ['a'], 'ã„': ['i', 'yi'], 'ã†': ['u', 'wu'], 'ãˆ': ['e'], 'ãŠ': ['o'],
      'ã‹': ['ka', 'ca'], 'ã': ['ki'], 'ã': ['ku', 'cu', 'qu'], 'ã‘': ['ke'], 'ã“': ['ko', 'co'],
      'ãŒ': ['ga'], 'ã': ['gi'], 'ã': ['gu'], 'ã’': ['ge'], 'ã”': ['go'],
      'ã•': ['sa'], 'ã—': ['si', 'shi', 'ci'], 'ã™': ['su'], 'ã›': ['se', 'ce'], 'ã': ['so'],
      'ã–': ['za'], 'ã˜': ['zi', 'ji'], 'ãš': ['zu'], 'ãœ': ['ze'], 'ã': ['zo'],
      'ãŸ': ['ta'], 'ã¡': ['ti', 'chi'], 'ã¤': ['tu', 'tsu'], 'ã¦': ['te'], 'ã¨': ['to'],
      'ã ': ['da'], 'ã¢': ['di', 'dzi'], 'ã¥': ['du', 'dzu'], 'ã§': ['de'], 'ã©': ['do'],
      'ãª': ['na'], 'ã«': ['ni'], 'ã¬': ['nu'], 'ã­': ['ne'], 'ã®': ['no'],
      'ã¯': ['ha'], 'ã²': ['hi'], 'ãµ': ['hu', 'fu'], 'ã¸': ['he'], 'ã»': ['ho'],
      'ã°': ['ba'], 'ã³': ['bi'], 'ã¶': ['bu'], 'ã¹': ['be'], 'ã¼': ['bo'],
      'ã±': ['pa'], 'ã´': ['pi'], 'ã·': ['pu'], 'ãº': ['pe'], 'ã½': ['po'],
      'ã¾': ['ma'], 'ã¿': ['mi'], 'ã‚€': ['mu'], 'ã‚': ['me'], 'ã‚‚': ['mo'],
      'ã‚„': ['ya'], 'ã‚†': ['yu'], 'ã‚ˆ': ['yo'],
      'ã‚‰': ['ra'], 'ã‚Š': ['ri'], 'ã‚‹': ['ru'], 'ã‚Œ': ['re'], 'ã‚': ['ro'],
      'ã‚': ['wa'], 'ã‚’': ['wo'], 'ã‚“': ['n', 'nn', 'xn'],
      'ã‚ƒ': ['xya', 'lya'], 'ã‚…': ['xyu', 'lyu'], 'ã‚‡': ['xyo', 'lyo'],
      'ã': ['xa', 'la'], 'ãƒ': ['xi', 'li'], 'ã…': ['xu', 'lu'], 'ã‡': ['xe', 'le'], 'ã‰': ['xo', 'lo'],
      'ã£': ['xtu', 'ltu', 'ltsu'],
      'ãã‚ƒ': ['kya'], 'ãã‚…': ['kyu'], 'ãã‚‡': ['kyo'],
      'ã—ã‚ƒ': ['sya', 'sha'], 'ã—ã‚…': ['syu', 'shu'], 'ã—ã‚‡': ['syo', 'sho'],
      'ã¡ã‚ƒ': ['tya', 'cha', 'cya'], 'ã¡ã‚…': ['tyu', 'chu', 'cyu'], 'ã¡ã‚‡': ['tyo', 'cho', 'cyo'],
      'ã«ã‚ƒ': ['nya'], 'ã«ã‚…': ['nyu'], 'ã«ã‚‡': ['nyo'],
      'ã²ã‚ƒ': ['hya'], 'ã²ã‚…': ['hyu'], 'ã²ã‚‡': ['hyo'],
      'ã¿ã‚ƒ': ['mya'], 'ã¿ã‚…': ['myu'], 'ã¿ã‚‡': ['myo'],
      'ã‚Šã‚ƒ': ['rya'], 'ã‚Šã‚…': ['ryu'], 'ã‚Šã‚‡': ['ryo'],
      'ãã‚ƒ': ['gya'], 'ãã‚…': ['gyu'], 'ãã‚‡': ['gyo'],
      'ã˜ã‚ƒ': ['ja', 'jya', 'zya'], 'ã˜ã‚…': ['ju', 'jyu', 'zyu'], 'ã˜ã‚‡': ['jo', 'jyo', 'zyo'],
      'ã³ã‚ƒ': ['bya'], 'ã³ã‚…': ['byu'], 'ã³ã‚‡': ['byo'],
      'ã´ã‚ƒ': ['pya'], 'ã´ã‚…': ['pyu'], 'ã´ã‚‡': ['pyo'],
      'ãµã': ['fa'], 'ãµãƒ': ['fi'], 'ãµã‡': ['fe'], 'ãµã‰': ['fo'],
      'ã¦ãƒ': ['thi'], 'ã§ãƒ': ['dhi'],
      'ã†ãƒ': ['wi'], 'ã†ã‡': ['we'], 'ã†ã‰': ['wo'],
      'ãƒ¼': ['-']
    };

    // ã²ã‚‰ãŒãªã‚’ãƒ­ãƒ¼ãƒå­—ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¤‰æ›
    function convertToRomajiPatterns(hiragana) {
      const patterns = [];
      let i = 0;
      while (i < hiragana.length) {
        const char = hiragana[i];
        const nextChar = hiragana[i + 1] || '';
        const combo = char + nextChar;
        
        const twoChar = romajiMap[combo];
        if (twoChar && twoChar.length > 0) {
          patterns.push(twoChar);
          i += 2;
        } else {
          const oneChar = romajiMap[char];
          if (oneChar && oneChar.length > 0) {
            patterns.push(oneChar);
          } else {
            patterns.push([char]);
          }
          i += 1;
        }
      }
      return patterns;
    }

    const words = {
      easy: [
        { japanese: 'ã¾ãã‚', hiragana: 'ã¾ãã‚', price: 120 },
        { japanese: 'ã•ã‘', hiragana: 'ã•ã‘', price: 100 },
        { japanese: 'ãŸã¾ã”', hiragana: 'ãŸã¾ã”', price: 140 },
        { japanese: 'ã„ã‹', hiragana: 'ã„ã‹', price: 100 },
        { japanese: 'ãˆã³', hiragana: 'ãˆã³', price: 100 },
        { japanese: 'ã†ã«', hiragana: 'ã†ã«', price: 150 },
        { japanese: 'ã„ãã‚‰', hiragana: 'ã„ãã‚‰', price: 120 },
        { japanese: 'ã‚ã˜', hiragana: 'ã‚ã˜', price: 100 },
        { japanese: 'ã•ã°', hiragana: 'ã•ã°', price: 100 },
        { japanese: 'ãŸã“', hiragana: 'ãŸã“', price: 100 }
      ],
      normal: [
        { japanese: 'ãŠã„ã—ã„', hiragana: 'ãŠã„ã—ã„', price: 280 },
        { japanese: 'ã‚ã‚ŠãŒã¨ã†', hiragana: 'ã‚ã‚ŠãŒã¨ã†', price: 320 },
        { japanese: 'ã—ã‚“ã›ã‚“', hiragana: 'ã—ã‚“ã›ã‚“', price: 280 },
        { japanese: 'ã™ã—ã‚„', hiragana: 'ã™ã—ã‚„', price: 260 },
        { japanese: 'ã‹ã„ã¦ã‚“', hiragana: 'ã‹ã„ã¦ã‚“', price: 280 },
        { japanese: 'ãŠã¡ã‚ƒ', hiragana: 'ãŠã¡ã‚ƒ', price: 200 },
        { japanese: 'ã‚ã•ã³', hiragana: 'ã‚ã•ã³', price: 240 },
        { japanese: 'ã—ã‚‡ã†ãŒ', hiragana: 'ã—ã‚‡ã†ãŒ', price: 280 },
        { japanese: 'ãŠã¦ãµã', hiragana: 'ãŠã¦ãµã', price: 280 },
        { japanese: 'ã»ãŸã¦ãŒã„', hiragana: 'ã»ãŸã¦ãŒã„', price: 360 }
      ],
      hard: [
        { japanese: 'ãŠãŠã¨ã‚', hiragana: 'ãŠãŠã¨ã‚', price: 480 },
        { japanese: 'ã—ã‚ƒã‚ŠãŒãŠã„ã—ã„', hiragana: 'ã—ã‚ƒã‚ŠãŒãŠã„ã—ã„', price: 640 },
        { japanese: 'ã‹ã„ã¦ã‚“ãšã—', hiragana: 'ã‹ã„ã¦ã‚“ãšã—', price: 560 },
        { japanese: 'ã‚ã¶ã‚Šã‚µãƒ¼ãƒ¢ãƒ³', hiragana: 'ã‚ã¶ã‚Šã•ãƒ¼ã‚‚ã‚“', price: 600 },
        { japanese: 'ã„ãã‚‰ãã‚“ã‹ã‚“', hiragana: 'ã„ãã‚‰ãã‚“ã‹ã‚“', price: 600 },
        { japanese: 'ã¡ã‚…ã†ã¨ã‚', hiragana: 'ã¡ã‚…ã†ã¨ã‚', price: 520 },
        { japanese: 'ãˆã‚“ãŒã‚', hiragana: 'ãˆã‚“ãŒã‚', price: 480 },
        { japanese: 'ã‹ã‚“ã±ã¡', hiragana: 'ã‹ã‚“ã±ã¡', price: 480 },
        { japanese: 'ã¶ã‚Šã¨ã‚', hiragana: 'ã¶ã‚Šã¨ã‚', price: 480 },
        { japanese: 'ã»ãŸã¦ã®ã«ãã‚Š', hiragana: 'ã»ãŸã¦ã®ã«ãã‚Š', price: 680 }
      ]
    };

    const courseSettings = {
      easy: { name: 'ãŠæ‰‹è»½3,000å††ã‚³ãƒ¼ã‚¹', time: 60, cost: 3000 },
      normal: { name: 'ãŠå‹§ã‚5,000å††ã‚³ãƒ¼ã‚¹', time: 90, cost: 5000 },
      hard: { name: 'é«˜ç´š10,000å††ã‚³ãƒ¼ã‚¹', time: 120, cost: 10000 }
    };

    const modeSettings = {
      practice: { name: 'ç·´ç¿’', speed: 0.5, description: 'æ™®é€šã‚ˆã‚Šã‚¹ãƒ”ãƒ¼ãƒ‰ãŒé…ã„ã€‚åˆ¶é™æ™‚é–“ãŒ0ã«ãªã£ãŸã‚‰çµ‚äº†ã€‚' },
      normal: { name: 'æ™®é€š', speed: 0.8, description: 'æ™®é€šã®ã‚¹ãƒ”ãƒ¼ãƒ‰ã€‚åˆ¶é™æ™‚é–“ãŒ0ã«ãªã£ãŸã‚‰çµ‚äº†ã€‚' },
      accuracy: { name: 'æ­£ç¢ºé‡è¦–', speed: 0.8, description: 'ãƒŸã‚¹ã‚¿ã‚¤ãƒ—ã‚’ã™ã‚‹ã¨ã€ã‚¿ã‚¤ãƒ—ä¸­ã®ãŠçš¿ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã€æ–°ã—ã„çš¿ã«ãªã‚‹ã€‚' },
      speed: { name: 'é€Ÿåº¦å¿…é ˆ', speed: 1.0, description: '1åº¦ã§ã‚‚ãŠçš¿ãŒç”»é¢å¤–ã«æµã‚Œã¦ã„ãã‹ã€åˆ¶é™æ™‚é–“ãŒ0ã«ãªã£ãŸã‚‰çµ‚äº†ã€‚' },
      oneshot: { name: 'ä¸€ç™ºå‹è² ', speed: 0.8, description: 'ãƒŸã‚¹ã‚¿ã‚¤ãƒ—ã‚’ã—ãŸã‚Šã€ãŠçš¿ãŒç”»é¢å¤–ã«æµã‚Œã¦ã„ãã¨ã€ãã®å ´ã§çµ‚äº†ã€‚' }
    };

    const menuEl = document.getElementById('menu');
    const modeSelectEl = document.getElementById('mode-select');
    const playingEl = document.getElementById('playing');
    const resultEl = document.getElementById('result');
    const selectedCourseNameEl = document.getElementById('selected-course-name');
    const modesContainer = document.getElementById('modes-container');
    const japaneseWordEl = document.getElementById('japanese-word');
    const typedTextEl = document.getElementById('typed-text');
    const remainingRomajiEl = document.getElementById('remaining-romaji');
    const sushiEl = document.getElementById('sushi');
    const beltEl = document.getElementById('belt');
    const speechBoxEl = document.getElementById('speech-box');
    const scoreEl = document.getElementById('score');
    const meterInnerEl = document.getElementById('meter-inner');
    const comboEl = document.getElementById('combo');
    const timeLeftEl = document.getElementById('time-left');
    const correctCountEl = document.getElementById('correct-count');
    const missCountEl = document.getElementById('miss-count');
    const unitPriceEl = document.getElementById('unit-price');
    const modeNameEl = document.getElementById('mode-name');
    const resultSubEl = document.getElementById('result-sub');
    const resultScoreEl = document.getElementById('result-score');
    const resultCostEl = document.getElementById('result-cost');
    const profitBoxEl = document.getElementById('profit-box');
    const resultCorrectEl = document.getElementById('result-correct');
    const resultMissEl = document.getElementById('result-miss');
    const resultAccuracyEl = document.getElementById('result-accuracy');

    let gameState = 'menu';
    let course = 'normal';
    let mode = 'normal';
    let currentWord = null;
    let currentPatterns = [];
    let currentPaths = [];
    let typedText = '';
    let score = 0;
    let timeLeft = 90;
    let correctCount = 0;
    let missCount = 0;
    let combo = 0;
    let totalKeystrokes = 0;
    let sushiPosition = 100;
    let timerInterval = null;
    let moveInterval = null;
    let keyHandler = null;

    function showMenu(){ menuEl.style.display='block'; modeSelectEl.style.display='none'; playingEl.style.display='none'; resultEl.style.display='none'; gameState='menu'; }
    function showModeSelect(){ menuEl.style.display='none'; modeSelectEl.style.display='block'; playingEl.style.display='none'; resultEl.style.display='none'; gameState='menu'; }
    function showPlaying(){ menuEl.style.display='none'; modeSelectEl.style.display='none'; playingEl.style.display='block'; resultEl.style.display='none'; gameState='playing'; }
    function showResult(){ menuEl.style.display='none'; modeSelectEl.style.display='none'; playingEl.style.display='none'; resultEl.style.display='block'; gameState='result'; }

    function createParticle(emoji, x, y){
      const particle = document.createElement('div');
      particle.className = 'particle';
      particle.textContent = emoji;
      particle.style.left = x + 'px';
      particle.style.top = y + 'px';
      beltEl.appendChild(particle);
      setTimeout(()=> particle.remove(), 1000);
    }

    function initModeButtons(){
      modesContainer.innerHTML = '';
      for (const key in modeSettings){
        const m = modeSettings[key];
        const div = document.createElement('div');
        div.className = 'mode-box';
        div.innerHTML = '<h3 style="margin:0;color:#333">'+m.name+'</h3><p class="muted" style="margin:6px 0 10px">'+m.description+'</p>';
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.style.background = 'var(--light-brown)';
        btn.style.color = '#fff';
        btn.style.display = 'block';
        btn.style.width = '100%';
        btn.style.padding = '10px';
        btn.textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆ';
        btn.addEventListener('mouseover', ()=> btn.style.background = 'var(--brown)');
        btn.addEventListener('mouseout', ()=> btn.style.background = 'var(--light-brown)');
        btn.addEventListener('click', ()=> { mode = key; startGame(); });
        div.appendChild(btn);
        modesContainer.appendChild(div);
      }
    }
    initModeButtons();

    function pickRandomWord(){
      const list = words[course];
      return list[Math.floor(Math.random()*list.length)];
    }

    function setNewWord(w){
      currentWord = w;
      currentPatterns = convertToRomajiPatterns(w.hiragana);
      typedText = '';
      sushiPosition = 100;
      initializePaths();
      updateUIWord();
      unitPriceEl.textContent = w.price + 'å††';
      sushiEl.style.left = sushiPosition + '%';
    }

    function getNewWord(){
      setNewWord(pickRandomWord());
    }

    function initializePaths(){
      currentPaths = [{ position: 0, partialInput: '' }];
    }

    function getRemainingRomaji(){
      if (currentPaths.length === 0) return '';
      
      let shortest = null;
      for (let path of currentPaths){
        let remaining = path.partialInput;
        
        for (let i = path.position; i < currentPatterns.length; i++){
          const options = currentPatterns[i];
          if (i === path.position && path.partialInput.length > 0){
            const matchedOption = options.find(opt => opt.startsWith(path.partialInput));
            if (matchedOption){
              remaining = matchedOption.slice(path.partialInput.length);
            }
          }
          if (i > path.position && options && options.length > 0){
            remaining += options[0];
          }
        }
        
        if (shortest === null || remaining.length < shortest.length){
          shortest = remaining;
        }
      }
      
      return shortest || '';
    }

    function updateUIWord(){
      japaneseWordEl.textContent = currentWord ? currentWord.japanese : '---';
      typedTextEl.textContent = typedText;
      remainingRomajiEl.textContent = getRemainingRomaji();
      const meterPercent = Math.min((combo % 10) * 10, 100);
      meterInnerEl.style.width = meterPercent + '%';
      comboEl.textContent = 'ã‚³ãƒ³ãƒœ: ' + combo;
    }

    function updateScoreUI(){
      scoreEl.textContent = score + 'å††';
    }

    function updateTimeUI(){
      timeLeftEl.textContent = timeLeft + 'ç§’';
      if (timeLeft <= 10 && timeLeft > 0){
        timeLeftEl.classList.add('time-warning');
      } else {
        timeLeftEl.classList.remove('time-warning');
      }
    }

    function updateCountsUI(){
      correctCountEl.textContent = correctCount + 'çš¿';
      missCountEl.textContent = missCount + 'å›';
    }

    function clearIntervals(){
      if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
      if (moveInterval) { clearInterval(moveInterval); moveInterval = null; }
      if (keyHandler) { window.removeEventListener('keydown', keyHandler); keyHandler = null; }
    }

    function startGame(){
      score = 0;
      timeLeft = courseSettings[course].time;
      correctCount = 0;
      missCount = 0;
      totalKeystrokes = 0;
      combo = 0;
      sushiPosition = 100;
      modeNameEl.textContent = modeSettings[mode].name + 'ãƒ¢ãƒ¼ãƒ‰';
      selectedCourseNameEl.textContent = courseSettings[course].name;
      updateScoreUI(); updateTimeUI(); updateCountsUI();
      getNewWord();
      showPlaying();

      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(()=>{
        timeLeft--;
        if (timeLeft <= 0){
          timeLeft = 0;
          updateTimeUI();
          endGame();
        } else {
          updateTimeUI();
        }
      },1000);

      if (moveInterval) clearInterval(moveInterval);
      const speed = modeSettings[mode].speed;
      moveInterval = setInterval(()=>{
        sushiPosition = sushiPosition - speed;
        sushiEl.style.left = sushiPosition + '%';
        if (sushiPosition <= -20){
          handleMissedSushi();
          sushiPosition = 100;
          sushiEl.style.left = sushiPosition + '%';
        }
      },50);

      if (keyHandler) window.removeEventListener('keydown', keyHandler);
      keyHandler = function(e){
        if (gameState !== 'playing') return;
        if (e.key.length === 1 && /[a-z-]/i.test(e.key)){
          e.preventDefault();
          const key = e.key.toLowerCase();
          totalKeystrokes++;
          
          const newPaths = [];
          
          for (let path of currentPaths){
            if (path.position >= currentPatterns.length) continue;
            
            const options = currentPatterns[path.position];
            const testInput = path.partialInput + key;
            
            for (let option of options){
              if (option.startsWith(testInput)){
                if (testInput === option){
                  newPaths.push({ position: path.position + 1, partialInput: '' });
                } else {
                  newPaths.push({ position: path.position, partialInput: testInput });
                }
              }
            }
          }
          
          if (newPaths.length > 0){
            currentPaths = newPaths;
            typedText += key;
            combo++;
            
            const allComplete = currentPaths.every(p => p.position >= currentPatterns.length);
            
            if (combo > 0 && combo % 10 === 0){
              timeLeft += 2;
              updateTimeUI();
              const rect = sushiEl.getBoundingClientRect();
              createParticle('â°+2', rect.left, rect.top);
            }
            
            if (allComplete){
              score += currentWord.price;
              correctCount++;
              sushiEl.classList.add('correct');
              const rect = sushiEl.getBoundingClientRect();
              createParticle('ğŸ’°', rect.left, rect.top);
              setTimeout(()=> sushiEl.classList.remove('correct'), 300);
              updateScoreUI();
              updateCountsUI();
              getNewWord();
            } else {
              updateUIWord();
            }
          } else {
            handleMissType();
          }
        }
      };
      window.addEventListener('keydown', keyHandler);
      updateUIWord();
    }

    function handleMissType(){
      missCount++;
      combo = 0;
      speechBoxEl.classList.add('shake');
      setTimeout(()=> speechBoxEl.classList.remove('shake'), 300);
      updateCountsUI();
      if (mode === 'accuracy'){
        getNewWord();
      } else if (mode === 'oneshot'){
        endGame();
      } else {
        initializePaths();
        updateUIWord();
      }
    }

    function handleMissedSushi(){
      missCount++;
      combo = 0;
      updateCountsUI();
      updateUIWord();
      if (mode === 'speed' || mode === 'oneshot'){
        endGame();
      } else {
        getNewWord();
      }
    }

    function endGame(){
      clearIntervals();
      showResult();
      const courseCost = courseSettings[course].cost;
      const profit = score - courseCost;
      const accuracy = totalKeystrokes > 0 ? Math.round((totalKeystrokes - missCount) / totalKeystrokes * 100) : 0;
      
      resultSubEl.textContent = courseSettings[course].name + ' - ' + modeSettings[mode].name + 'ãƒ¢ãƒ¼ãƒ‰';
      resultScoreEl.textContent = score + 'å††';
      resultCostEl.textContent = courseCost + 'å††';
      resultCorrectEl.textContent = correctCount + 'çš¿';
      resultMissEl.textContent = missCount + 'å›';
      resultAccuracyEl.textContent = accuracy + '%';

      profitBoxEl.style.border = '5px solid ' + (profit >= 0 ? '#90EE90' : '#FFB6C1');
      profitBoxEl.style.background = profit >= 0 ? '#F0FFF0' : '#FFF0F5';
      profitBoxEl.innerHTML = '<div class="muted">ãŠå¾—é¡</div><div style="font-size:2.4rem;font-weight:800;color:' + (profit >= 0 ? '#228B22' : '#DC143C') + '">' + (profit >= 0 ? '+' : '') + profit + 'å††</div>' + (profit >= 0 ? '<div style="margin-top:8px;font-size:1.2rem;font-weight:700;color:#228B22">ğŸ‰ å…ƒãŒå–ã‚Œã¾ã—ãŸï¼</div>' : '<div style="margin-top:8px;font-size:1rem;color:#DC143C">æ¬¡å›é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼</div>');
    }

    document.getElementById('start-easy').addEventListener('click', ()=>{
      course = 'easy';
      selectedCourseNameEl.textContent = courseSettings[course].name;
      showModeSelect();
    });
    document.getElementById('start-normal').addEventListener('click', ()=>{
      course = 'normal';
      selectedCourseNameEl.textContent = courseSettings[course].name;
      showModeSelect();
    });
    document.getElementById('start-hard').addEventListener('click', ()=>{
      course = 'hard';
      selectedCourseNameEl.textContent = courseSettings[course].name;
      showModeSelect();
    });

    document.getElementById('back-to-course').addEventListener('click', ()=>{
      showMenu();
    });

    document.getElementById('back-to-menu').addEventListener('click', ()=>{
      clearIntervals();
      showMenu();
    });

    document.addEventListener('selectstart', (e)=>e.preventDefault());
  </script>
</body>
</html>
