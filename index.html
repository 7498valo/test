import React, { useState, useEffect } from 'react';

const SushiTypingGame = () => {
  const [gameState, setGameState] = useState('menu');
  const [mode, setMode] = useState('normal');
  const [course, setCourse] = useState('normal');
  const [currentWord, setCurrentWord] = useState('');
  const [currentRomaji, setCurrentRomaji] = useState('');
  const [typedText, setTypedText] = useState('');
  const [score, setScore] = useState(0);
  const [timeLeft, setTimeLeft] = useState(90);
  const [correctCount, setCorrectCount] = useState(0);
  const [missCount, setMissCount] = useState(0);
  const [combo, setCombo] = useState(0);
  const [sushiPosition, setSushiPosition] = useState(100);
  const [showModeSelect, setShowModeSelect] = useState(false);

  const words = {
    easy: [
      { japanese: 'ã¾ãã‚', romaji: 'maguro', price: 120 },
      { japanese: 'ã•ã‘', romaji: 'sake', price: 100 },
      { japanese: 'ãŸã¾ã”', romaji: 'tamago', price: 140 },
      { japanese: 'ã„ã‹', romaji: 'ika', price: 100 },
      { japanese: 'ãˆã³', romaji: 'ebi', price: 100 },
      { japanese: 'ã†ã«', romaji: 'uni', price: 150 },
      { japanese: 'ã„ãã‚‰', romaji: 'ikura', price: 120 },
      { japanese: 'ã‚ã˜', romaji: 'aji', price: 100 },
      { japanese: 'ã•ã°', romaji: 'saba', price: 100 },
      { japanese: 'ãŸã“', romaji: 'tako', price: 100 },
    ],
    normal: [
      { japanese: 'ãŠã„ã—ã„', romaji: 'oishii', price: 280 },
      { japanese: 'ã‚ã‚ŠãŒã¨ã†', romaji: 'arigatou', price: 320 },
      { japanese: 'ã—ã‚“ã›ã‚“', romaji: 'shinsen', price: 280 },
      { japanese: 'ã™ã—ã‚„', romaji: 'sushiya', price: 260 },
      { japanese: 'ã‹ã„ã¦ã‚“', romaji: 'kaiten', price: 280 },
      { japanese: 'ãŠã¡ã‚ƒ', romaji: 'ocha', price: 200 },
      { japanese: 'ã‚ã•ã³', romaji: 'wasabi', price: 240 },
      { japanese: 'ã—ã‚‡ã†ãŒ', romaji: 'shouga', price: 280 },
      { japanese: 'ãŠã¦ãµã', romaji: 'otefuki', price: 280 },
      { japanese: 'ã»ãŸã¦ãŒã„', romaji: 'hotategai', price: 360 },
    ],
    hard: [
      { japanese: 'ãŠãŠã¨ã‚', romaji: 'ootoro', price: 480 },
      { japanese: 'ã—ã‚ƒã‚ŠãŒãŠã„ã—ã„', romaji: 'sharigaoishii', price: 640 },
      { japanese: 'ã‹ã„ã¦ã‚“ãšã—', romaji: 'kaitenzushi', price: 560 },
      { japanese: 'ã‚ã¶ã‚Šã‚µãƒ¼ãƒ¢ãƒ³', romaji: 'aburisaamon', price: 600 },
      { japanese: 'ã„ãã‚‰ãã‚“ã‹ã‚“', romaji: 'ikuragunkan', price: 600 },
      { japanese: 'ã¡ã‚…ã†ã¨ã‚', romaji: 'chuutoro', price: 520 },
      { japanese: 'ãˆã‚“ãŒã‚', romaji: 'engawa', price: 480 },
      { japanese: 'ã‹ã‚“ã±ã¡', romaji: 'kanpachi', price: 480 },
      { japanese: 'ã¶ã‚Šã¨ã‚', romaji: 'buritoro', price: 480 },
      { japanese: 'ã»ãŸã¦ã®ã«ãã‚Š', romaji: 'hotatenonigiri', price: 680 },
    ]
  };

  const courseSettings = {
    easy: { name: 'ãŠæ‰‹è»½3,000å††ã‚³ãƒ¼ã‚¹', time: 60, cost: 3000 },
    normal: { name: 'ãŠå‹§ã‚5,000å††ã‚³ãƒ¼ã‚¹', time: 90, cost: 5000 },
    hard: { name: 'é«˜ç´š10,000å††ã‚³ãƒ¼ã‚¹', time: 120, cost: 10000 }
  };

  const modeSettings = {
    practice: { name: 'ç·´ç¿’', speed: 0.5, description: 'æ™®é€šã‚ˆã‚Šã‚¹ãƒ”ãƒ¼ãƒ‰ãŒé…ã„ã€‚åˆ¶é™æ™‚é–“ãŒ0ã«ãªã£ãŸã‚‰çµ‚äº†ã€‚' },
    normal: { name: 'æ™®é€š', speed: 0.8, description: 'æ™®é€šã®ã‚¹ãƒ”ãƒ¼ãƒ‰ã€‚åˆ¶é™æ™‚é–“ãŒ0ã«ãªã£ãŸã‚‰çµ‚äº†ã€‚' },
    accuracy: { name: 'æ­£ç¢ºé‡è¦–', speed: 0.8, description: 'ãƒŸã‚¹ã‚¿ã‚¤ãƒ—ã‚’ã™ã‚‹ã¨ã€ã‚¿ã‚¤ãƒ—ä¸­ã®ãŠçš¿ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã€æ–°ã—ã„çš¿ã«ãªã‚‹ã€‚' },
    speed: { name: 'é€Ÿåº¦å¿…é ˆ', speed: 1.0, description: '1åº¦ã§ã‚‚ãŠçš¿ãŒç”»é¢å¤–ã«æµã‚Œã¦ã„ãã‹ã€åˆ¶é™æ™‚é–“ãŒ0ã«ãªã£ãŸã‚‰çµ‚äº†ã€‚' },
    oneshot: { name: 'ä¸€ç™ºå‹è² ', speed: 0.8, description: 'ãƒŸã‚¹ã‚¿ã‚¤ãƒ—ã‚’ã—ãŸã‚Šã€ãŠçš¿ãŒç”»é¢å¤–ã«æµã‚Œã¦ã„ãã¨ã€ãã®å ´ã§çµ‚äº†ã€‚' }
  };

  useEffect(() => {
    if (gameState === 'playing' && timeLeft > 0) {
      const timer = setInterval(() => {
        setTimeLeft(prev => {
          if (prev <= 1) {
            setGameState('result');
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
      return () => clearInterval(timer);
    }
  }, [gameState, timeLeft]);

  useEffect(() => {
    if (gameState === 'playing') {
      const speed = modeSettings[mode].speed;
      const moveInterval = setInterval(() => {
        setSushiPosition(prev => {
          if (prev <= -20) {
            handleMissedSushi();
            return 100;
          }
          return prev - speed;
        });
      }, 50);
      return () => clearInterval(moveInterval);
    }
  }, [gameState, currentWord, mode]);

  useEffect(() => {
    if (gameState === 'playing') {
      const handleKeyDown = (e) => {
        if (e.key.length === 1 && /[a-z]/i.test(e.key)) {
          e.preventDefault();
          const key = e.key.toLowerCase();
          const nextChar = currentRomaji[typedText.length];
          
          if (key === nextChar) {
            const newTyped = typedText + key;
            setTypedText(newTyped);
            setCombo(prev => prev + 1);
            
            if (combo > 0 && combo % 10 === 0) {
              setTimeLeft(prev => prev + 2);
            }
            
            if (newTyped === currentRomaji) {
              setScore(prev => prev + currentWord.price);
              setCorrectCount(prev => prev + 1);
              getNewWord();
            }
          } else {
            handleMissType();
          }
        }
      };

      window.addEventListener('keydown', handleKeyDown);
      return () => window.removeEventListener('keydown', handleKeyDown);
    }
  }, [gameState, typedText, currentRomaji, currentWord, combo, mode]);

  const handleMissType = () => {
    setMissCount(prev => prev + 1);
    setCombo(0);
    
    if (mode === 'accuracy') {
      getNewWord();
    } else if (mode === 'oneshot') {
      setGameState('result');
    }
  };

  const handleMissedSushi = () => {
    setMissCount(c => c + 1);
    setCombo(0);
    
    if (mode === 'speed' || mode === 'oneshot') {
      setGameState('result');
    } else {
      getNewWord();
    }
  };

  const getNewWord = () => {
    const wordList = words[course];
    const newWord = wordList[Math.floor(Math.random() * wordList.length)];
    setCurrentWord(newWord);
    setCurrentRomaji(newWord.romaji);
    setTypedText('');
    setSushiPosition(100);
  };

  const startGame = () => {
    setGameState('playing');
    setScore(0);
    setTimeLeft(courseSettings[course].time);
    setCorrectCount(0);
    setMissCount(0);
    setCombo(0);
    setTypedText('');
    const wordList = words[course];
    const newWord = wordList[Math.floor(Math.random() * wordList.length)];
    setCurrentWord(newWord);
    setCurrentRomaji(newWord.romaji);
    setSushiPosition(100);
  };

  const resetGame = () => {
    setGameState('menu');
    setShowModeSelect(false);
  };

  const selectCourse = (selectedCourse) => {
    setCourse(selectedCourse);
    setShowModeSelect(true);
  };

  const courseCost = courseSettings[course].cost;
  const profit = score - courseCost;

  return (
    <div className="min-h-screen" style={{ background: 'linear-gradient(to bottom, #fff8dc 0%, #ffe4b5 100%)' }}>
      <div className="max-w-6xl mx-auto p-6">
        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <div className="text-center mb-6">
          <h1 
            className="text-7xl font-black mb-1" 
            style={{ 
              color: '#CD853F',
              textShadow: '4px 4px 0 #fff, 8px 8px 0 #8B4513',
              fontFamily: 'Arial Black, sans-serif',
              letterSpacing: '2px'
            }}
          >
            å¯¿å¸æ‰“
          </h1>
          <p className="text-xs text-gray-500 tracking-widest">Sushida - TypingGame</p>
        </div>

        {gameState === 'menu' && !showModeSelect && (
          <div style={{ background: '#FFF', border: '5px solid #8B4513', borderRadius: '10px', padding: '40px' }}>
            <h2 className="text-center text-3xl font-bold mb-8" style={{ color: '#8B4513' }}>
              ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„
            </h2>

            <div className="space-y-6 max-w-3xl mx-auto">
              <div style={{ border: '3px solid #90EE90', background: '#F0FFF0', borderRadius: '8px', padding: '24px' }}>
                <h3 className="text-2xl font-bold mb-3" style={{ color: '#228B22' }}>ãŠæ‰‹è»½ 3,000å††ã‚³ãƒ¼ã‚¹</h3>
                <p className="text-gray-700 mb-4">æ–‡å­—æ•°2ã€œ7æ–‡å­—ã€åˆ¶é™æ™‚é–“60ç§’</p>
                <button
                  onClick={() => selectCourse('easy')}
                  className="w-full font-bold py-3 px-6 rounded"
                  style={{ background: '#32CD32', color: 'white' }}
                  onMouseOver={(e) => e.target.style.background = '#228B22'}
                  onMouseOut={(e) => e.target.style.background = '#32CD32'}
                >
                  ã‚¹ã‚¿ãƒ¼ãƒˆ
                </button>
              </div>

              <div style={{ border: '3px solid #87CEEB', background: '#F0F8FF', borderRadius: '8px', padding: '24px' }}>
                <h3 className="text-2xl font-bold mb-3" style={{ color: '#4169E1' }}>ãŠå‹§ã‚ 5,000å††ã‚³ãƒ¼ã‚¹</h3>
                <p className="text-gray-700 mb-4">æ–‡å­—æ•°5ã€œ10æ–‡å­—ã€åˆ¶é™æ™‚é–“90ç§’</p>
                <button
                  onClick={() => selectCourse('normal')}
                  className="w-full font-bold py-3 px-6 rounded"
                  style={{ background: '#4169E1', color: 'white' }}
                  onMouseOver={(e) => e.target.style.background = '#1E40AF'}
                  onMouseOut={(e) => e.target.style.background = '#4169E1'}
                >
                  ã‚¹ã‚¿ãƒ¼ãƒˆ
                </button>
              </div>

              <div style={{ border: '3px solid #FFB6C1', background: '#FFF0F5', borderRadius: '8px', padding: '24px' }}>
                <h3 className="text-2xl font-bold mb-3" style={{ color: '#DC143C' }}>é«˜ç´š 10,000å††ã‚³ãƒ¼ã‚¹</h3>
                <p className="text-gray-700 mb-4">æ–‡å­—æ•°9ã€œ14æ–‡å­—ä»¥ä¸Šã€åˆ¶é™æ™‚é–“120ç§’</p>
                <button
                  onClick={() => selectCourse('hard')}
                  className="w-full font-bold py-3 px-6 rounded"
                  style={{ background: '#DC143C', color: 'white' }}
                  onMouseOver={(e) => e.target.style.background = '#B22222'}
                  onMouseOut={(e) => e.target.style.background = '#DC143C'}
                >
                  ã‚¹ã‚¿ãƒ¼ãƒˆ
                </button>
              </div>
            </div>
          </div>
        )}

        {gameState === 'menu' && showModeSelect && (
          <div style={{ background: '#FFF', border: '5px solid #8B4513', borderRadius: '10px', padding: '40px' }}>
            <h2 className="text-center text-3xl font-bold mb-2" style={{ color: '#8B4513' }}>
              ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„
            </h2>
            <p className="text-center text-xl text-gray-600 mb-8">{courseSettings[course].name}</p>

            <div className="space-y-4 max-w-3xl mx-auto">
              {Object.entries(modeSettings).map(([key, value]) => (
                <div key={key} style={{ border: '2px solid #D3D3D3', background: '#FAFAFA', borderRadius: '6px', padding: '20px' }}>
                  <h3 className="text-xl font-bold mb-2" style={{ color: '#333' }}>{value.name}</h3>
                  <p className="text-sm text-gray-600 mb-3">{value.description}</p>
                  <button
                    onClick={() => { setMode(key); startGame(); }}
                    className="w-full font-bold py-2 px-6 rounded"
                    style={{ background: '#CD853F', color: 'white' }}
                    onMouseOver={(e) => e.target.style.background = '#8B4513'}
                    onMouseOut={(e) => e.target.style.background = '#CD853F'}
                  >
                    ã‚¹ã‚¿ãƒ¼ãƒˆ
                  </button>
                </div>
              ))}
            </div>

            <div className="text-center mt-6">
              <button
                onClick={() => setShowModeSelect(false)}
                className="underline"
                style={{ color: '#4169E1' }}
              >
                â† ã‚³ãƒ¼ã‚¹é¸æŠã«æˆ»ã‚‹
              </button>
            </div>
          </div>
        )}

        {gameState === 'playing' && (
          <div style={{ background: '#FFF', border: '5px solid #8B4513', borderRadius: '10px', overflow: 'hidden' }}>
            {/* ã‚¹ã‚³ã‚¢ã‚¨ãƒªã‚¢ */}
            <div style={{ background: 'linear-gradient(to bottom, #FFEFD5, #FFE4B5)', borderBottom: '5px solid #8B4513', padding: '16px' }}>
              <div className="flex justify-between items-center">
                <div className="text-lg">
                  <span className="font-bold" style={{ color: '#8B4513' }}>ç²å¾—:</span>
                  <span className="ml-2 font-bold text-2xl" style={{ color: '#4169E1' }}>{score}å††</span>
                </div>
                <div className="text-center">
                  <div className="text-xs mb-1" style={{ color: '#8B4513' }}>é€£æ‰“ãƒ¡ãƒ¼ã‚¿ãƒ¼</div>
                  <div style={{ width: '200px', height: '16px', background: '#E5E5E5', borderRadius: '8px', overflow: 'hidden', border: '2px solid #999' }}>
                    <div 
                      style={{ 
                        height: '100%', 
                        background: 'linear-gradient(to right, #FFD700, #FF6347)',
                        width: `${Math.min((combo % 10) * 10, 100)}%`,
                        transition: 'width 0.1s'
                      }}
                    />
                  </div>
                  <div className="text-xs mt-1" style={{ color: '#666' }}>ã‚³ãƒ³ãƒœ: {combo}</div>
                </div>
                <div className="text-lg">
                  <span className="font-bold" style={{ color: '#8B4513' }}>æ®‹ã‚Š:</span>
                  <span className="ml-2 font-bold text-3xl" style={{ color: '#DC143C' }}>{timeLeft}ç§’</span>
                </div>
              </div>
            </div>

            {/* ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ */}
            <div style={{ position: 'relative', height: '280px', background: 'linear-gradient(to bottom, #87CEEB 0%, #E0F6FF 100%)' }}>
              {/* ãƒ™ãƒ«ãƒˆã‚³ãƒ³ãƒ™ã‚¢ */}
              <div style={{ 
                position: 'absolute', 
                bottom: 0, 
                left: 0, 
                right: 0, 
                height: '100px',
                background: 'linear-gradient(to bottom, #8B4513 0%, #654321 50%, #3E2723 100%)',
                borderTop: '5px solid #5D4037'
              }}>
                <div style={{
                  position: 'absolute',
                  inset: 0,
                  backgroundImage: 'repeating-linear-gradient(90deg, transparent, transparent 40px, rgba(255,255,255,0.1) 40px, rgba(255,255,255,0.1) 42px)'
                }} />
                {/* å¯¿å¸ */}
                <div 
                  style={{ 
                    position: 'absolute', 
                    top: '50%', 
                    transform: 'translateY(-50%)',
                    left: `${sushiPosition}%`,
                    transition: 'left 0.05s linear',
                    fontSize: '64px'
                  }}
                >
                  ğŸ£
                </div>
              </div>
              
              {/* ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ */}
              <div style={{ position: 'absolute', top: '30px', left: 0, right: 0, textAlign: 'center' }}>
                <div style={{ 
                  background: 'rgba(255, 255, 255, 0.95)', 
                  display: 'inline-block', 
                  padding: '20px 40px', 
                  borderRadius: '15px', 
                  border: '3px solid #DDD',
                  boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
                }}>
                  <div className="text-5xl font-bold mb-3" style={{ color: '#333' }}>
                    {currentWord.japanese}
                  </div>
                  <div className="text-4xl" style={{ fontFamily: 'monospace' }}>
                    <span className="font-bold" style={{ color: '#4169E1' }}>{typedText}</span>
                    <span style={{ color: '#CCC' }}>{currentRomaji.slice(typedText.length)}</span>
                  </div>
                </div>
              </div>
            </div>

            {/* ä¸‹éƒ¨æƒ…å ± */}
            <div style={{ background: 'linear-gradient(to bottom, #F5F5F5, #E8E8E8)', borderTop: '5px solid #8B4513', padding: '16px' }}>
              <div className="flex justify-between text-base">
                <div><span style={{ color: '#8B4513' }}>æ­£è§£:</span> <span className="font-bold" style={{ color: '#228B22' }}>{correctCount}çš¿</span></div>
                <div><span style={{ color: '#8B4513' }}>ãƒŸã‚¹:</span> <span className="font-bold" style={{ color: '#DC143C' }}>{missCount}å›</span></div>
                <div><span style={{ color: '#8B4513' }}>å˜ä¾¡:</span> <span className="font-bold">{currentWord.price}å††</span></div>
                <div style={{ color: '#666' }}>{modeSettings[mode].name}ãƒ¢ãƒ¼ãƒ‰</div>
              </div>
            </div>
          </div>
        )}

        {gameState === 'result' && (
          <div style={{ background: '#FFF', border: '5px solid #8B4513', borderRadius: '10px', padding: '40px' }}>
            <h2 className="text-center text-5xl font-bold mb-2" style={{ color: '#8B4513' }}>
              çµæœç™ºè¡¨
            </h2>
            <p className="text-center text-gray-600 mb-8">{courseSettings[course].name} - {modeSettings[mode].name}ãƒ¢ãƒ¼ãƒ‰</p>
            
            <div className="max-w-xl mx-auto space-y-5 mb-8">
              <div style={{ border: '3px solid #87CEEB', background: '#F0F8FF', borderRadius: '10px', padding: '24px' }}>
                <div className="text-center">
                  <div className="text-lg mb-2" style={{ color: '#666' }}>ç²å¾—é‡‘é¡</div>
                  <div className="text-6xl font-bold" style={{ color: '#4169E1' }}>{score}å††</div>
                </div>
              </div>

              <div style={{ border: '3px solid #FFB347', background: '#FFF8DC', borderRadius: '10px', padding: '24px' }}>
                <div className="text-center">
                  <div className="text-lg mb-2" style={{ color: '#666' }}>ãŠä¼šè¨ˆ</div>
                  <div className="text-6xl font-bold" style={{ color: '#FF8C00' }}>{courseCost}å††</div>
                </div>
              </div>

              <div style={{ 
                border: `5px solid ${profit >= 0 ? '#90EE90' : '#FFB6C1'}`, 
                background: profit >= 0 ? '#F0FFF0' : '#FFF0F5', 
                borderRadius: '10px', 
                padding: '32px' 
              }}>
                <div className="text-center">
                  <div className="text-lg mb-2" style={{ color: '#666' }}>ãŠå¾—é¡</div>
                  <div className="text-7xl font-bold" style={{ color: profit >= 0 ? '#228B22' : '#DC143C' }}>
                    {profit >= 0 ? '+' : ''}{profit}å††
                  </div>
                  {profit >= 0 && (
                    <div className="mt-4 text-2xl font-bold" style={{ color: '#228B22' }}>
                      ğŸ‰ å…ƒãŒå–ã‚Œã¾ã—ãŸï¼
                    </div>
                  )}
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div style={{ border: '2px solid #DDD', background: '#FAFAFA', borderRadius: '8px', padding: '16px', textAlign: 'center' }}>
                  <div className="text-gray-600 mb-1">æ­£è§£æ•°</div>
                  <div className="text-4xl font-bold" style={{ color: '#228B22' }}>{correctCount}çš¿</div>
                </div>
                <div style={{ border: '2px solid #DDD', background: '#FAFAFA', borderRadius: '8px', padding: '16px', textAlign: 'center' }}>
                  <div className="text-gray-600 mb-1">ãƒŸã‚¹æ•°</div>
                  <div className="text-4xl font-bold" style={{ color: '#DC143C' }}>{missCount}å›</div>
                </div>
              </div>
            </div>

            <div className="text-center">
              <button
                onClick={resetGame}
                className="font-bold text-2xl py-4 px-16 rounded"
                style={{ background: '#CD853F', color: 'white' }}
                onMouseOver={(e) => e.target.style.background = '#8B4513'}
                onMouseOut={(e) => e.target.style.background = '#CD853F'}
              >
                ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹
              </button>
            </div>
          </div>
        )}

        {/* ãƒ•ãƒƒã‚¿ãƒ¼ */}
        <div className="text-center mt-6 text-sm text-gray-600">
          <p>â€»ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§æ–‡å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        </div>
      </div>
    </div>
  );
};

export default SushiTypingGame;
